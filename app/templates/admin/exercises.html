{% extends "admin/layout.html" %}

{% block title %}Manage Exercises - Sweatz Admin{% endblock %}

{% block page_title %}Manage Exercises{% endblock %}

{% block actions %}
<div class="d-flex gap-2">
    <a href="{{ url_for('admin.add_exercise_route') }}" class="btn btn-primary">Add New Exercise</a>
    
    <form action="{{ url_for('admin.exercises') }}" method="GET" class="d-flex gap-2">
        <div class="input-group">
            <input type="text" name="search" class="form-control" placeholder="Search exercises..." value="{{ request.args.get('search', '') }}">
            <button type="submit" class="btn btn-outline-primary">Search</button>
        </div>
        
        <select name="muscle_group" class="form-select" style="width: auto;">
            <option value="">All Muscle Groups</option>
            {% for group in muscle_groups %}
            <option value="{{ group }}" {% if request.args.get('muscle_group') == group %}selected{% endif %}>{{ group }}</option>
            {% endfor %}
        </select>
        
        <select name="difficulty" class="form-select" style="width: auto;">
            <option value="">All Difficulties</option>
            <option value="beginner" {% if request.args.get('difficulty') == 'beginner' %}selected{% endif %}>Beginner</option>
            <option value="intermediate" {% if request.args.get('difficulty') == 'intermediate' %}selected{% endif %}>Intermediate</option>
            <option value="advanced" {% if request.args.get('difficulty') == 'advanced' %}selected{% endif %}>Advanced</option>
        </select>
        
        <select name="equipment" class="form-select" style="width: auto;">
            <option value="">All Equipment</option>
            {% for equip in equipment_list %}
            <option value="{{ equip }}" {% if request.args.get('equipment') == equip %}selected{% endif %}>{{ equip|title }}</option>
            {% endfor %}
        </select>
        
        <button type="submit" class="btn btn-primary">Filter</button>
        <a href="{{ url_for('admin.exercises') }}" class="btn btn-outline-secondary">Reset</a>
    </form>
</div>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>Exercises ({{ total_exercises }})</span>
        <div>
            <button id="bulkDeleteBtn" class="btn btn-danger btn-sm" disabled>Delete Selected</button>
            <a href="{{ url_for('admin.export_exercises') }}" class="btn btn-secondary btn-sm">Export CSV</a>
        </div>
    </div>
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>
                        <input type="checkbox" id="selectAllExercises" class="form-check-input">
                    </th>
                    <th>Name</th>
                    <th>Muscle Group</th>
                    <th>Difficulty</th>
                    <th>Equipment</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for exercise in exercises %}
                <tr>
                    <td>
                        <input type="checkbox" class="exercise-select form-check-input" value="{{ exercise._id }}">
                    </td>
                    <td>{{ exercise.name }}</td>
                    <td>
                        <span class="badge bg-secondary">{{ exercise.muscle_group }}</span>
                    </td>
                    <td>
                        {% if exercise.difficulty == 'beginner' %}
                        <span class="badge bg-success">Beginner</span>
                        {% elif exercise.difficulty == 'intermediate' %}
                        <span class="badge bg-warning">Intermediate</span>
                        {% elif exercise.difficulty == 'advanced' %}
                        <span class="badge bg-danger">Advanced</span>
                        {% else %}
                        <span class="badge bg-secondary">{{ exercise.difficulty }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% for item in exercise.equipment %}
                        <span class="badge bg-info me-1">{{ item }}</span>
                        {% endfor %}
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <a href="{{ url_for('admin.edit_exercise', exercise_id=exercise._id) }}" class="btn btn-primary" title="Edit Exercise">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button type="button" class="btn btn-info view-exercise-btn" data-exercise-id="{{ exercise._id }}" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button type="button" class="btn btn-danger delete-exercise-btn" data-exercise-id="{{ exercise._id }}" title="Delete Exercise">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                
                {% if exercises|length == 0 %}
                <tr>
                    <td colspan="6" class="text-center py-3">
                        {% if request.args %}
                        <p class="mb-0">No exercises match your filter criteria. <a href="{{ url_for('admin.exercises') }}">Clear filters</a></p>
                        {% else %}
                        <p class="mb-0">No exercises have been added yet.</p>
                        {% endif %}
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
    
    {% if total_pages > 1 %}
    <div class="card-footer">
        <nav aria-label="Exercise pagination">
            <ul class="pagination justify-content-center mb-0">
                <li class="page-item {% if page == 1 %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('admin.exercises', page=page-1, muscle_group=request.args.get('muscle_group'), difficulty=request.args.get('difficulty'), equipment=request.args.get('equipment'), search=request.args.get('search')) }}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                
                {% for i in range(1, total_pages + 1) %}
                {% if i == page %}
                <li class="page-item active" aria-current="page">
                    <span class="page-link">{{ i }}</span>
                </li>
                {% elif i >= page - 2 and i <= page + 2 or i == 1 or i == total_pages %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('admin.exercises', page=i, muscle_group=request.args.get('muscle_group'), difficulty=request.args.get('difficulty'), equipment=request.args.get('equipment'), search=request.args.get('search')) }}">{{ i }}</a>
                </li>
                {% elif i == page - 3 or i == page + 3 %}
                <li class="page-item disabled">
                    <span class="page-link">...</span>
                </li>
                {% endif %}
                {% endfor %}
                
                <li class="page-item {% if page == total_pages %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('admin.exercises', page=page+1, muscle_group=request.args.get('muscle_group'), difficulty=request.args.get('difficulty'), equipment=request.args.get('equipment'), search=request.args.get('search')) }}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>
    {% endif %}
</div>

<!-- Exercise Detail Modal -->
<div class="modal fade" id="exerciseDetailModal" tabindex="-1" aria-labelledby="exerciseDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exerciseDetailModalLabel">Exercise Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center py-4" id="exerciseDetailLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="exerciseDetailContent" class="d-none">
                    <h3 id="detailExerciseName"></h3>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Muscle Group:</strong> <span id="detailMuscleGroup"></span></p>
                            <p><strong>Difficulty:</strong> <span id="detailDifficulty"></span></p>
                            <p><strong>Equipment:</strong> <span id="detailEquipment"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Created:</strong> <span id="detailCreatedAt"></span></p>
                            <p><strong>Created By:</strong> <span id="detailCreatedBy"></span></p>
                            <p><strong>Last Updated:</strong> <span id="detailUpdatedAt"></span></p>
                        </div>
                    </div>
                    
                    <h5>Description</h5>
                    <p id="detailDescription" class="mb-4"></p>
                    
                    <h5>Instructions</h5>
                    <div id="detailInstructions" class="mb-4"></div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Video Demonstration</h5>
                            <div id="detailVideoContainer" class="ratio ratio-16x9">
                                <!-- Video will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="#" id="editExerciseBtn" class="btn btn-primary">Edit Exercise</a>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteExerciseModal" tabindex="-1" aria-labelledby="deleteExerciseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteExerciseModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this exercise? This action cannot be undone.</p>
                <p><strong>Exercise:</strong> <span id="deleteExerciseName"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete Exercise</button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Delete Modal -->
<div class="modal fade" id="bulkDeleteModal" tabindex="-1" aria-labelledby="bulkDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkDeleteModalLabel">Confirm Bulk Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the selected exercises? This action cannot be undone.</p>
                <p><strong>Selected exercises:</strong> <span id="bulkDeleteCount">0</span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmBulkDeleteBtn">Delete Exercises</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Exercise detail view
    const viewExerciseBtns = document.querySelectorAll('.view-exercise-btn');
    viewExerciseBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const exerciseId = this.getAttribute('data-exercise-id');
            openExerciseDetailModal(exerciseId);
        });
    });
    
    // Delete exercise
    const deleteExerciseBtns = document.querySelectorAll('.delete-exercise-btn');
    let exerciseToDelete = null;
    
    deleteExerciseBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            exerciseToDelete = this.getAttribute('data-exercise-id');
            const exerciseName = this.closest('tr').querySelector('td:nth-child(2)').textContent;
            document.getElementById('deleteExerciseName').textContent = exerciseName;
            
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteExerciseModal'));
            deleteModal.show();
        });
    });
    
    // Confirm delete
    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        if (exerciseToDelete) {
            deleteExercise(exerciseToDelete);
        }
    });
    
    // Select all exercises checkbox
    const selectAllCheckbox = document.getElementById('selectAllExercises');
    const exerciseCheckboxes = document.querySelectorAll('.exercise-select');
    
    selectAllCheckbox.addEventListener('change', function() {
        const isChecked = this.checked;
        exerciseCheckboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
        });
        updateBulkDeleteButton();
    });
    
    // Individual checkboxes
    exerciseCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateBulkDeleteButton);
    });
    
    // Bulk delete button
    const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
    bulkDeleteBtn.addEventListener('click', function() {
        const selectedExercises = getSelectedExercises();
        document.getElementById('bulkDeleteCount').textContent = selectedExercises.length;
        
        const bulkDeleteModal = new bootstrap.Modal(document.getElementById('bulkDeleteModal'));
        bulkDeleteModal.show();
    });
    
    // Confirm bulk delete
    document.getElementById('confirmBulkDeleteBtn').addEventListener('click', function() {
        const selectedExercises = getSelectedExercises();
        if (selectedExercises.length > 0) {
            bulkDeleteExercises(selectedExercises);
        }
    });
    
    // Functions
    function openExerciseDetailModal(exerciseId) {
        // Show loading state
        document.getElementById('exerciseDetailLoading').classList.remove('d-none');
        document.getElementById('exerciseDetailContent').classList.add('d-none');
        
        // Open modal
        const modal = new bootstrap.Modal(document.getElementById('exerciseDetailModal'));
        modal.show();
        
        // Fetch exercise details
        fetch(`/admin/api/exercises/${exerciseId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    populateExerciseDetails(data.exercise);
                } else {
                    alert('Error loading exercise details: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error fetching exercise details:', error);
                alert('Error loading exercise details. Please try again.');
            })
            .finally(() => {
                document.getElementById('exerciseDetailLoading').classList.add('d-none');
                document.getElementById('exerciseDetailContent').classList.remove('d-none');
            });
            
        // Update edit button href
        document.getElementById('editExerciseBtn').href = `/admin/exercises/edit/${exerciseId}`;
    }
    
    function populateExerciseDetails(exercise) {
        document.getElementById('detailExerciseName').textContent = exercise.name;
        document.getElementById('detailMuscleGroup').textContent = exercise.muscle_group;
        
        // Set difficulty with badge
        const difficultySpan = document.getElementById('detailDifficulty');
        difficultySpan.textContent = exercise.difficulty.charAt(0).toUpperCase() + exercise.difficulty.slice(1);
        difficultySpan.className = '';
        if (exercise.difficulty === 'beginner') {
            difficultySpan.className = 'badge bg-success';
        } else if (exercise.difficulty === 'intermediate') {
            difficultySpan.className = 'badge bg-warning';
        } else if (exercise.difficulty === 'advanced') {
            difficultySpan.className = 'badge bg-danger';
        }
        
        // Equipment list
        const equipmentSpan = document.getElementById('detailEquipment');
        equipmentSpan.innerHTML = '';
        if (exercise.equipment && exercise.equipment.length > 0) {
            exercise.equipment.forEach(item => {
                const badge = document.createElement('span');
                badge.className = 'badge bg-info me-1';
                badge.textContent = item;
                equipmentSpan.appendChild(badge);
            });
        } else {
            equipmentSpan.textContent = 'None specified';
        }
        
        // Creation info
        document.getElementById('detailCreatedAt').textContent = new Date(exercise.created_at).toLocaleString();
        document.getElementById('detailCreatedBy').textContent = exercise.created_by_username || 'System';
        document.getElementById('detailUpdatedAt').textContent = exercise.updated_at ? new Date(exercise.updated_at).toLocaleString() : 'Never';
        
        // Description and instructions
        document.getElementById('detailDescription').textContent = exercise.description || 'No description provided.';
        
        const instructionsDiv = document.getElementById('detailInstructions');
        instructionsDiv.innerHTML = '';
        if (exercise.instruction) {
            const instructionsList = exercise.instruction.split('\n');
            const ol = document.createElement('ol');
            instructionsList.forEach(instruction => {
                if (instruction.trim()) {
                    const li = document.createElement('li');
                    li.textContent = instruction.trim();
                    ol.appendChild(li);
                }
            });
            instructionsDiv.appendChild(ol);
        } else {
            instructionsDiv.textContent = 'No instructions provided.';
        }
        
        // Video embed if available
        const videoContainer = document.getElementById('detailVideoContainer');
        videoContainer.innerHTML = '';
        if (exercise.video_url) {
            // Check if it's a YouTube URL
            if (exercise.video_url.includes('youtube.com') || exercise.video_url.includes('youtu.be')) {
                // Extract video ID
                let videoId = '';
                if (exercise.video_url.includes('v=')) {
                    videoId = exercise.video_url.split('v=')[1].split('&')[0];
                } else if (exercise.video_url.includes('youtu.be/')) {
                    videoId = exercise.video_url.split('youtu.be/')[1];
                }
                
                if (videoId) {
                    const iframe = document.createElement('iframe');
                    iframe.src = `https://www.youtube.com/embed/${videoId}`;
                    iframe.title = "YouTube video player";
                    iframe.frameBorder = "0";
                    iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
                    iframe.allowFullscreen = true;
                    videoContainer.appendChild(iframe);
                } else {
                    videoContainer.innerHTML = `<div class="alert alert-info">Video available at: <a href="${exercise.video_url}" target="_blank">${exercise.video_url}</a></div>`;
                }
            } else {
                videoContainer.innerHTML = `<div class="alert alert-info">Video available at: <a href="${exercise.video_url}" target="_blank">${exercise.video_url}</a></div>`;
            }
        } else {
            videoContainer.innerHTML = '<div class="alert alert-secondary">No video demonstration available.</div>';
        }
    }
    
    function deleteExercise(exerciseId) {
        fetch(`/admin/api/exercises/${exerciseId}`, {
            method: 'DELETE',
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('deleteExerciseModal')).hide();
                
                // Reload page to show updated list
                window.location.reload();
            } else {
                alert('Error deleting exercise: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error deleting exercise:', error);
            alert('Error deleting exercise. Please try again.');
        });
    }
    
    function updateBulkDeleteButton() {
        const selectedExercises = getSelectedExercises();
        const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
        
        if (selectedExercises.length > 0) {
            bulkDeleteBtn.removeAttribute('disabled');
            bulkDeleteBtn.textContent = `Delete Selected (${selectedExercises.length})`;
        } else {
            bulkDeleteBtn.setAttribute('disabled', 'disabled');
            bulkDeleteBtn.textContent = 'Delete Selected';
        }
    }
    
    function getSelectedExercises() {
        const selectedExercises = [];
        document.querySelectorAll('.exercise-select:checked').forEach(checkbox => {
            selectedExercises.push(checkbox.value);
        });
        return selectedExercises;
    }
    
    function bulkDeleteExercises(exerciseIds) {
        fetch('/admin/api/exercises/bulk-delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                exercise_ids: exerciseIds
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('bulkDeleteModal')).hide();
                
                // Reload page to show updated list
                window.location.reload();
            } else {
                alert('Error deleting exercises: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error bulk deleting exercises:', error);
            alert('Error deleting exercises. Please try again.');
        });
    }
});
</script>
{% endblock %}