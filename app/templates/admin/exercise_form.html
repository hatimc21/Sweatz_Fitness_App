{% extends "admin/layout.html" %}

{% block title %}{% if exercise %}Edit Exercise{% else %}Add Exercise{% endif %} - Sweatz Admin{% endblock %}

{% block page_title %}{% if exercise %}Edit Exercise{% else %}Add Exercise{% endif %}{% endblock %}

{% block actions %}
<div>
    <a href="{{ url_for('admin.exercises') }}" class="btn btn-secondary">Back to Exercises</a>
</div>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <span>{% if exercise %}Edit Exercise: {{ exercise.name }}{% else %}Add New Exercise{% endif %}</span>
    </div>
    <div class="card-body">
        <form action="{% if exercise %}{{ url_for('admin.edit_exercise', exercise_id=exercise._id) }}{% else %}{{ url_for('admin.add_exercise_route') }}{% endif %}" method="POST">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label for="name" class="form-label">Exercise Name <span class="text-danger">*</span></label>
                        <input type="text" id="name" name="name" class="form-control" value="{{ exercise.name if exercise else '' }}" required>
                    </div>
                    
                    <div class="form-group mb-3">
                        <label for="muscle_group" class="form-label">Muscle Group <span class="text-danger">*</span></label>
                        <select id="muscle_group" name="muscle_group" class="form-select" required>
                            <option value="">Select Muscle Group</option>
                            <option value="Chest" {% if exercise and exercise.muscle_group == 'Chest' %}selected{% endif %}>Chest</option>
                            <option value="Back" {% if exercise and exercise.muscle_group == 'Back' %}selected{% endif %}>Back</option>
                            <option value="Shoulders" {% if exercise and exercise.muscle_group == 'Shoulders' %}selected{% endif %}>Shoulders</option>
                            <option value="Arms" {% if exercise and exercise.muscle_group == 'Arms' %}selected{% endif %}>Arms</option>
                            <option value="Legs" {% if exercise and exercise.muscle_group == 'Legs' %}selected{% endif %}>Legs</option>
                            <option value="Core" {% if exercise and exercise.muscle_group == 'Core' %}selected{% endif %}>Core</option>
                            <option value="Full Body" {% if exercise and exercise.muscle_group == 'Full Body' %}selected{% endif %}>Full Body</option>
                            <option value="Cardio" {% if exercise and exercise.muscle_group == 'Cardio' %}selected{% endif %}>Cardio</option>
                        </select>
                    </div>
                    
                    <div class="form-group mb-3">
                        <label for="difficulty" class="form-label">Difficulty Level <span class="text-danger">*</span></label>
                        <select id="difficulty" name="difficulty" class="form-select" required>
                            <option value="">Select Difficulty</option>
                            <option value="beginner" {% if exercise and exercise.difficulty == 'beginner' %}selected{% endif %}>Beginner</option>
                            <option value="intermediate" {% if exercise and exercise.difficulty == 'intermediate' %}selected{% endif %}>Intermediate</option>
                            <option value="advanced" {% if exercise and exercise.difficulty == 'advanced' %}selected{% endif %}>Advanced</option>
                        </select>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label class="form-label">Equipment (select all that apply)</label>
                        <div class="equipment-options" style="max-height: 200px; overflow-y: auto; border: 1px solid #ced4da; padding: 10px; border-radius: 4px;">
                            {% for equipment in ['barbell', 'dumbbell', 'kettlebell', 'cable', 'machine', 'bodyweight', 'resistance bands', 'medicine ball', 'stability ball', 'foam roller', 'bench', 'pull-up bar'] %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="equipment-{{ equipment|replace(' ', '-') }}" name="equipment" value="{{ equipment }}" 
                                {% if exercise and exercise.equipment and equipment in exercise.equipment %}checked{% endif %}>
                                <label class="form-check-label" for="equipment-{{ equipment|replace(' ', '-') }}">{{ equipment|title }}</label>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="form-text">If equipment not listed, add in "Other Equipment" field below.</div>
                    </div>
                    
                    <div class="form-group mb-3">
                        <label for="other_equipment" class="form-label">Other Equipment (comma separated)</label>
                        <input type="text" id="other_equipment" name="other_equipment" class="form-control" placeholder="e.g., trx, bosu ball">
                    </div>
                </div>
            </div>
            
            <div class="form-group mb-3">
                <label for="description" class="form-label">Description <span class="text-danger">*</span></label>
                <textarea id="description" name="description" class="form-control" rows="4" required>{{ exercise.description if exercise else '' }}</textarea>
                <div class="form-text">Provide a brief description of the exercise, its benefits, and muscles targeted.</div>
            </div>
            
            <div class="form-group mb-3">
                <label for="instruction" class="form-label">Instructions <span class="text-danger">*</span></label>
                <textarea id="instruction" name="instruction" class="form-control" rows="6" required>{{ exercise.instruction if exercise else '' }}</textarea>
                <div class="form-text">Enter step-by-step instructions, one step per line.</div>
            </div>
            
            <div class="form-group mb-3">
                <label for="video_url" class="form-label">Video URL (YouTube or Demo Link)</label>
                <input type="url" id="video_url" name="video_url" class="form-control" value="{{ exercise.video_url if exercise else '' }}" placeholder="e.g., https://www.youtube.com/watch?v=...">
                <div class="form-text">YouTube links will be embedded in the app.</div>
            </div>
            
            <div class="form-group mb-3">
                <label for="tips" class="form-label">Tips and Common Mistakes (optional)</label>
                <textarea id="tips" name="tips" class="form-control" rows="4">{{ exercise.tips if exercise else '' }}</textarea>
                <div class="form-text">Provide tips for proper form and common mistakes to avoid.</div>
            </div>
            
            <div class="form-group">
                <button type="submit" class="btn btn-primary">{% if exercise %}Update Exercise{% else %}Add Exercise{% endif %}</button>
                
                {% if exercise %}
                <button type="button" class="btn btn-danger" onclick="confirmDelete('{{ exercise._id }}')">Delete Exercise</button>
                {% endif %}
                
                <a href="{{ url_for('admin.exercises') }}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>

{% if exercise %}
<!-- Preview Exercise Modal -->
<div class="modal fade" id="previewExerciseModal" tabindex="-1" aria-labelledby="previewExerciseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewExerciseModalLabel">Exercise Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <h3>{{ exercise.name }}</h3>
                    <div>
                        <span class="badge bg-secondary">{{ exercise.muscle_group }}</span>
                        
                        {% if exercise.difficulty == 'beginner' %}
                        <span class="badge bg-success">Beginner</span>
                        {% elif exercise.difficulty == 'intermediate' %}
                        <span class="badge bg-warning">Intermediate</span>
                        {% elif exercise.difficulty == 'advanced' %}
                        <span class="badge bg-danger">Advanced</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h5>Description</h5>
                        <p>{{ exercise.description }}</p>
                    </div>
                    <div class="col-md-6">
                        <h5>Equipment</h5>
                        <div>
                            {% for item in exercise.equipment %}
                            <span class="badge bg-info me-1">{{ item }}</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-12">
                        <h5>Instructions</h5>
                        {% if exercise.instruction %}
                        <ol>
                            {% for line in exercise.instruction.split('\n') %}
                            {% if line.strip() %}
                            <li>{{ line }}</li>
                            {% endif %}
                            {% endfor %}
                        </ol>
                        {% else %}
                        <p>No instructions provided.</p>
                        {% endif %}
                    </div>
                </div>
                
                {% if exercise.video_url %}
                <div class="row mb-3">
                    <div class="col-12">
                        <h5>Video Demonstration</h5>
                        <div class="ratio ratio-16x9">
                            {% if 'youtube.com' in exercise.video_url or 'youtu.be' in exercise.video_url %}
                                {% if 'v=' in exercise.video_url %}
                                    {% set video_id = exercise.video_url.split('v=')[1].split('&')[0] %}
                                {% elif 'youtu.be/' in exercise.video_url %}
                                    {% set video_id = exercise.video_url.split('youtu.be/')[1] %}
                                {% endif %}
                                
                                {% if video_id %}
                                <iframe src="https://www.youtube.com/embed/{{ video_id }}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                {% else %}
                                <div class="alert alert-info">Video available at: <a href="{{ exercise.video_url }}" target="_blank">{{ exercise.video_url }}</a></div>
                                {% endif %}
                            {% else %}
                            <div class="alert alert-info">Video available at: <a href="{{ exercise.video_url }}" target="_blank">{{ exercise.video_url }}</a></div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% if exercise.tips %}
                <div class="row">
                    <div class="col-12">
                        <h5>Tips and Common Mistakes</h5>
                        <p>{{ exercise.tips }}</p>
                    </div>
                </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Prepare for form submission
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Gather selected equipment
        const selectedEquipment = [];
        document.querySelectorAll('input[name="equipment"]:checked').forEach(function(checkbox) {
            selectedEquipment.push(checkbox.value);
        });
        
        // Add other equipment if provided
        const otherEquipment = document.getElementById('other_equipment').value;
        if (otherEquipment) {
            otherEquipment.split(',').forEach(function(item) {
                const trimmed = item.trim();
                if (trimmed && !selectedEquipment.includes(trimmed)) {
                    selectedEquipment.push(trimmed);
                }
            });
        }
        
        // Create hidden input for equipment array
        const equipmentInput = document.createElement('input');
        equipmentInput.type = 'hidden';
        equipmentInput.name = 'equipment_json';
        equipmentInput.value = JSON.stringify(selectedEquipment);
        form.appendChild(equipmentInput);
        
        // Submit the form
        form.submit();
    });
    
    {% if exercise %}
    // Add a preview button
    const submitButton = form.querySelector('button[type="submit"]');
    const previewButton = document.createElement('button');
    previewButton.type = 'button';
    previewButton.className = 'btn btn-info me-2';
    previewButton.textContent = 'Preview';
    previewButton.addEventListener('click', function() {
        const previewModal = new bootstrap.Modal(document.getElementById('previewExerciseModal'));
        previewModal.show();
    });
    
    submitButton.parentNode.insertBefore(previewButton, submitButton);
    {% endif %}
});

{% if exercise %}
function confirmDelete(exerciseId) {
    if (confirm('Are you sure you want to delete this exercise? This action cannot be undone.')) {
        // Submit a delete request
        window.location.href = "{{ url_for('admin.delete_exercise', exercise_id='PLACEHOLDER') }}".replace('PLACEHOLDER', exerciseId);
    }
}
{% endif %}
</script>
{% endblock %}