{% extends "base.html" %}

{% block title %}Nutrition Goals - Sweatz{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col">
            <h1 class="h2 mb-0">Nutrition Goals</h1>
            <p class="text-muted">Set your daily nutrition targets</p>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Daily Goals</h5>
                </div>
                <div class="card-body">
                    <form id="nutritionGoalsForm">
                        <div class="row mb-4">
                            <div class="col-md-6 mb-3">
                                <label for="calories" class="form-label">Daily Calories (kcal)</label>
                                <input type="number" class="form-control" id="calories" name="calories" min="1000" max="10000" required>
                                <div class="form-text">Recommended range: 1500-3000 kcal</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="water" class="form-label">Daily Water Intake (ml)</label>
                                <input type="number" class="form-control" id="water" name="water" min="500" max="5000" required>
                                <div class="form-text">Recommended: 2000-3000 ml</div>
                            </div>
                        </div>
                        
                        <h6 class="mb-3">Macronutrient Goals</h6>
                        <div class="row mb-4">
                            <div class="col-md-4 mb-3">
                                <label for="protein" class="form-label">Protein (g)</label>
                                <input type="number" class="form-control" id="protein" name="protein" min="50" max="300" required>
                                <div id="protein-percent" class="form-text">0% of calories</div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="carbs" class="form-label">Carbohydrates (g)</label>
                                <input type="number" class="form-control" id="carbs" name="carbs" min="50" max="500" required>
                                <div id="carbs-percent" class="form-text">0% of calories</div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="fats" class="form-label">Fats (g)</label>
                                <input type="number" class="form-control" id="fats" name="fats" min="20" max="200" required>
                                <div id="fats-percent" class="form-text">0% of calories</div>
                            </div>
                        </div>
                        
                        <div class="progress mb-4" style="height: 25px;">
                            <div id="protein-bar" class="progress-bar bg-primary" style="width: 30%">
                                Protein: 30%
                            </div>
                            <div id="carbs-bar" class="progress-bar bg-success" style="width: 45%">
                                Carbs: 45%
                            </div>
                            <div id="fats-bar" class="progress-bar bg-danger" style="width: 25%">
                                Fats: 25%
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-6 mb-3">
                                <label for="goalType" class="form-label">Goal Type</label>
                                <select class="form-select" id="goalType" name="goalType">
                                    <option value="maintain">Maintain Weight</option>
                                    <option value="lose">Lose Weight</option>
                                    <option value="gain">Gain Weight</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="activityLevel" class="form-label">Activity Level</label>
                                <select class="form-select" id="activityLevel" name="activityLevel">
                                    <option value="sedentary">Sedentary (little or no exercise)</option>
                                    <option value="light">Lightly active (light exercise 1-3 days/week)</option>
                                    <option value="moderate">Moderately active (moderate exercise 3-5 days/week)</option>
                                    <option value="active">Active (hard exercise 6-7 days/week)</option>
                                    <option value="veryActive">Very active (very hard exercise & physical job)</option>
                                </select>
                            </div>
                        </div>
                        
                        <button type="button" id="calculateBtn" class="btn btn-secondary me-2">Calculate Recommended</button>
                        <button type="submit" class="btn btn-primary">Save Goals</button>
                    </form>
                </div>
            </div>
            
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Nutrition Tips</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <h6 class="alert-heading">Macro Breakdown</h6>
                        <p class="mb-0">A common macronutrient distribution is 30% protein, 45% carbs, and 25% fat. Adjust based on your specific goals and needs.</p>
                    </div>
                    
                    <h6>General Guidelines:</h6>
                    <ul>
                        <li>Protein: 1.6-2.2g per kg of bodyweight for active individuals</li>
                        <li>Carbs: 3-5g per kg for moderate to high activity levels</li>
                        <li>Fats: 0.5-1.5g per kg of bodyweight</li>
                        <li>Water: 35-45ml per kg of bodyweight</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Current Stats</h5>
                </div>
                <div class="card-body">
                    <form id="statsForm">
                        <div class="mb-3">
                            <label for="weight" class="form-label">Current Weight</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="weight" name="weight" step="0.1" min="30" max="300">
                                <span class="input-group-text">kg</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="height" class="form-label">Height</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="height" name="height" step="1" min="100" max="250">
                                <span class="input-group-text">cm</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="age" class="form-label">Age</label>
                            <input type="number" class="form-control" id="age" name="age" min="15" max="100">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Gender</label>
                            <div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="gender" id="male" value="male">
                                    <label class="form-check-label" for="male">Male</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="gender" id="female" value="female">
                                    <label class="form-check-label" for="female">Female</label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Weekly Analysis</h5>
                </div>
                <div class="card-body">
                    <div id="weeklyProgressChart" style="height: 250px; position: relative;">
                        <canvas id="macroChart"></canvas>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <div class="text-center">
                            <h6 class="mb-1">Weekly Avg</h6>
                            <span class="h5 mb-0 d-block" id="weeklyAvgCalories">0</span>
                            <small class="text-muted">calories</small>
                        </div>
                        <div class="text-center">
                            <h6 class="mb-1">Goal Met</h6>
                            <span class="h5 mb-0 d-block" id="goalMetDays">0/7</span>
                            <small class="text-muted">days</small>
                        </div>
                        <div class="text-center">
                            <h6 class="mb-1">Best Day</h6>
                            <span class="h5 mb-0 d-block" id="bestDay">-</span>
                            <small class="text-muted">closest to goal</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        loadNutritionGoals();
        initChart();
        
        // Initialize calculations
        const caloriesInput = document.getElementById('calories');
        const proteinInput = document.getElementById('protein');
        const carbsInput = document.getElementById('carbs');
        const fatsInput = document.getElementById('fats');
        
        // Calculate button
        document.getElementById('calculateBtn').addEventListener('click', calculateRecommended);
        
        // Save goals form
        document.getElementById('nutritionGoalsForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveNutritionGoals();
        });
        
        // Update macros percentages when values change
        caloriesInput.addEventListener('input', updateMacroPercentages);
        proteinInput.addEventListener('input', updateMacroPercentages);
        carbsInput.addEventListener('input', updateMacroPercentages);
        fatsInput.addEventListener('input', updateMacroPercentages);
        
        // Functions
        function loadNutritionGoals() {
            fetch('/api/nutrition/goals')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.goals) {
                        // Fill form with current goals
                        caloriesInput.value = data.goals.calories || 2000;
                        proteinInput.value = data.goals.protein || 150;
                        carbsInput.value = data.goals.carbs || 200;
                        fatsInput.value = data.goals.fats || 65;
                        document.getElementById('water').value = data.goals.water || 2000;
                        
                        // Update visuals
                        updateMacroPercentages();
                    }
                })
                .catch(error => {
                    console.error('Error loading nutrition goals:', error);
                });
                
            // Load weekly stats
            loadWeeklyStats();
        }
        
        function saveNutritionGoals() {
            const goals = {
                calories: parseInt(caloriesInput.value),
                protein: parseInt(proteinInput.value),
                carbs: parseInt(carbsInput.value),
                fats: parseInt(fatsInput.value),
                water: parseInt(document.getElementById('water').value)
            };
            
            fetch('/api/nutrition/goals', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(goals)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    alert('Nutrition goals saved successfully');
                } else {
                    alert('Error saving goals: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error saving nutrition goals:', error);
                alert('Error saving goals. Please try again.');
            });
        }
        
        function updateMacroPercentages() {
            const calories = parseInt(caloriesInput.value) || 0;
            const protein = parseInt(proteinInput.value) || 0;
            const carbs = parseInt(carbsInput.value) || 0;
            const fats = parseInt(fatsInput.value) || 0;
            
            // Calculate calories from each macro
            const proteinCals = protein * 4;
            const carbsCals = carbs * 4;
            const fatsCals = fats * 9;
            
            // Calculate percentages
            const totalCals = proteinCals + carbsCals + fatsCals;
            const proteinPerc = Math.round((proteinCals / totalCals) * 100) || 0;
            const carbsPerc = Math.round((carbsCals / totalCals) * 100) || 0;
            const fatsPerc = Math.round((fatsCals / totalCals) * 100) || 0;
            
            // Update text
            document.getElementById('protein-percent').textContent = `${proteinPerc}% of calories`;
            document.getElementById('carbs-percent').textContent = `${carbsPerc}% of calories`;
            document.getElementById('fats-percent').textContent = `${fatsPerc}% of calories`;
            
            // Update progress bars
            document.getElementById('protein-bar').style.width = `${proteinPerc}%`;
            document.getElementById('protein-bar').textContent = `Protein: ${proteinPerc}%`;
            
            document.getElementById('carbs-bar').style.width = `${carbsPerc}%`;
            document.getElementById('carbs-bar').textContent = `Carbs: ${carbsPerc}%`;
            
            document.getElementById('fats-bar').style.width = `${fatsPerc}%`;
            document.getElementById('fats-bar').textContent = `Fats: ${fatsPerc}%`;
        }
        
        function calculateRecommended() {
            // Get stats
            const weight = parseFloat(document.getElementById('weight').value);
            const height = parseFloat(document.getElementById('height').value);
            const age = parseInt(document.getElementById('age').value);
            const gender = document.querySelector('input[name="gender"]:checked')?.value;
            const activityLevel = document.getElementById('activityLevel').value;
            const goalType = document.getElementById('goalType').value;
            
            if (!weight || !height || !age || !gender) {
                alert('Please fill in your stats to calculate recommended values');
                return;
            }
            
            // Calculate BMR using Mifflin-St Jeor Equation
            let bmr;
            if (gender === 'male') {
                bmr = 10 * weight + 6.25 * height - 5 * age + 5;
            } else {
                bmr = 10 * weight + 6.25 * height - 5 * age - 161;
            }
            
            // Apply activity multiplier
            let tdee;
            switch (activityLevel) {
                case 'sedentary':
                    tdee = bmr * 1.2;
                    break;
                case 'light':
                    tdee = bmr * 1.375;
                    break;
                case 'moderate':
                    tdee = bmr * 1.55;
                    break;
                case 'active':
                    tdee = bmr * 1.725;
                    break;
                case 'veryActive':
                    tdee = bmr * 1.9;
                    break;
                default:
                    tdee = bmr * 1.2;
            }
            
            // Apply goal adjustment
            let calories;
            switch (goalType) {
                case 'lose':
                    calories = tdee - 500; // 500 calorie deficit
                    break;
                case 'gain':
                    calories = tdee + 500; // 500 calorie surplus
                    break;
                default:
                    calories = tdee; // Maintain
            }
            
            // Calculate macros
            // Default distribution: 30% protein, 45% carbs, 25% fat
            const protein = Math.round((calories * 0.3) / 4); // Protein: 4 calories per gram
            const carbs = Math.round((calories * 0.45) / 4);  // Carbs: 4 calories per gram
            const fats = Math.round((calories * 0.25) / 9);   // Fat: 9 calories per gram
            
            // Update form
            caloriesInput.value = Math.round(calories);
            proteinInput.value = protein;
            carbsInput.value = carbs;
            fatsInput.value = fats;
            document.getElementById('water').value = Math.round(weight * 35); // 35ml per kg
            
            // Update visuals
            updateMacroPercentages();
        }
        
        function initChart() {
            const ctx = document.getElementById('macroChart').getContext('2d');
            window.macroChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [
                        {
                            label: 'Calories',
                            data: [0, 0, 0, 0, 0, 0, 0],
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Goal',
                            data: [2000, 2000, 2000, 2000, 2000, 2000, 2000],
                            type: 'line',
                            fill: false,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 2,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Calories'
                            }
                        }
                    }
                }
            });
        }
        
        function loadWeeklyStats() {
            // This would normally fetch from API
            // For demo, using mock data
            const mockData = {
                daily: [
                    { day: 'Mon', calories: 1850 },
                    { day: 'Tue', calories: 2100 },
                    { day: 'Wed', calories: 1950 },
                    { day: 'Thu', calories: 2200 },
                    { day: 'Fri', calories: 2050 },
                    { day: 'Sat', calories: 2300 },
                    { day: 'Sun', calories: 1900 }
                ],
                goal: 2000,
                average: 2050,
                goalMetDays: 5,
                bestDay: 'Wed'
            };
            
            // Update chart
            window.macroChart.data.datasets[0].data = mockData.daily.map(d => d.calories);
            window.macroChart.data.datasets[1].data = Array(7).fill(mockData.goal);
            window.macroChart.update();
            
            // Update stats
            document.getElementById('weeklyAvgCalories').textContent = mockData.average;
            document.getElementById('goalMetDays').textContent = `${mockData.goalMetDays}/7`;
            document.getElementById('bestDay').textContent = mockData.bestDay;
        }
    });
</script>
{% endblock %}